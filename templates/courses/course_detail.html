{% extends 'base.html' %}

{% block title %}{{ course.course_name }} - 学生选课系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">
                    <i class="fas fa-book"></i>
                    {{ course.course_code }} - {{ course.course_name }}
                </h4>
            </div>
            <div class="card-body">
                <!-- 基本信息 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> 基本信息</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>课程代码:</strong></td>
                                <td>{{ course.course_code }}</td>
                            </tr>
                            <tr>
                                <td><strong>课程名称:</strong></td>
                                <td>{{ course.course_name }}</td>
                            </tr>
                            <tr>
                                <td><strong>学分:</strong></td>
                                <td>{{ course.credits }} 学分</td>
                            </tr>
                            <tr>
                                <td><strong>学时:</strong></td>
                                <td>{{ course.hours }} 学时</td>
                            </tr>
                            <tr>
                                <td><strong>学年:</strong></td>
                                <td>{{ course.academic_year|default:"未设定" }}</td>
                            </tr>
                            <tr>
                                <td><strong>学期:</strong></td>
                                <td>{{ course.semester|default:"未设定" }}</td>
                            </tr>
                            <tr>
                                <td><strong>创建时间:</strong></td>
                                <td>{{ course.created_at|date:"Y-m-d H:i" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-chart-bar"></i> 统计信息</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>开设班次:</strong></td>
                                <td>{{ classes.count }} 个</td>
                            </tr>
                            <tr>
                                <td><strong>总容量:</strong></td>
                                <td>{{ total_capacity }} 人</td>
                            </tr>
                            <tr>
                                <td><strong>已选人数:</strong></td>
                                <td>{{ total_enrolled }} 人</td>
                            </tr>
                            <tr>
                                <td><strong>剩余名额:</strong></td>
                                <td>{{ remaining_spots }} 人</td>
                            </tr>
                            <tr>
                                <td><strong>选课率:</strong></td>
                                <td>
                                    {% if total_capacity > 0 %}
                                        50%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- 课程描述 -->
                {% if course.description %}
                <div class="mb-4">
                    <h6><i class="fas fa-file-alt"></i> 课程描述</h6>
                    <div class="alert alert-light">
                        {{ course.description|linebreaks }}
                    </div>
                </div>
                {% endif %}

                <!-- 班次列表 -->
                <div class="mb-4">
                    <h6><i class="fas fa-chalkboard"></i> 开设班次</h6>
                    <div class="row">
                        {% for class_obj in classes %}
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header {% if class_obj.is_full %}bg-danger{% else %}bg-success{% endif %} text-white">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">{{ class_obj.class_code }}</h6>
                                        <span class="badge {% if class_obj.current_students >= class_obj.max_students %}bg-light text-dark{% else %}bg-light text-dark{% endif %}">
                                            {{ class_obj.current_students }}/{{ class_obj.max_students }}
                                        </span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p class="mb-1"><strong>授课教师:</strong> {{ class_obj.teacher.username }}</p>
                                            <p class="mb-1"><strong>教室:</strong> {{ class_obj.classroom|default:"未设定" }}</p>
                                            <p class="mb-1"><strong>时间:</strong> {{ class_obj.schedule|default:"未设定" }}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="progress mb-2" style="height: 15px;">
                                                <div class="progress-bar {% if class_obj.is_full %}bg-danger{% else %}bg-success{% endif %}"
                                                     style="width: {% widthratio class_obj.current_students class_obj.max_students 100 %}%"
                                                     title="{{ class_obj.current_students }}/{{ class_obj.max_students }}">
                                                </div>
                                            </div>
                                            <p class="text-muted small">选课进度</p>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between mt-2">
                                        <a href="{% url 'courses:class_detail' class_obj.id %}" class="btn btn-outline-primary btn-sm">
                                            <i class="fas fa-eye"></i> 详情
                                        </a>
                                        {% if user.user_type == 'student' and class_obj.current_students < class_obj.max_students %}
                                            <a href="{% url 'courses:enroll_course' class_obj.id %}" class="btn btn-success btn-sm">
                                                <i class="fas fa-plus"></i> 选课
                                            </a>
                                        {% elif user.user_type == 'admin' %}
                                            <a href="{% url 'courses:class_update' class_obj.id %}" class="btn btn-warning btn-sm me-1">
                                                <i class="fas fa-edit"></i> 编辑
                                            </a>
                                            <a href="{% url 'courses:class_create' %}?course={{ course.id }}" class="btn btn-success btn-sm">
                                                <i class="fas fa-plus"></i> 添加班次
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <div class="alert alert-warning text-center">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <h5 class="mb-2">暂无开设班次</h5>
                                <p class="mb-2">该课程目前还没有开设任何班次，无法进行选课。</p>
                                {% if user.user_type == 'admin' %}
                                    <a href="{% url 'courses:class_create' %}?course={{ course.id }}" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> 添加第一个班次
                                    </a>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- 选课学生列表（管理员和教师可见） -->
                {% if user.user_type == 'admin' or user.user_type == 'teacher' %}
                <div class="mb-4">
                    <h6><i class="fas fa-users"></i> 选课学生</h6>
                    {% if enrollments %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>学号</th>
                                        <th>姓名</th>
                                        <th>班次</th>
                                        <th>选课时间</th>
                                        <th>状态</th>
                                        <th>成绩</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for enrollment in enrollments %}
                                    <tr>
                                        <td>
                                            {% if enrollment.student.studentprofile %}
                                                {{ enrollment.student.studentprofile.student_number }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td>{{ enrollment.student.username }}</td>
                                        <td>
                                            <a href="{% url 'courses:class_detail' enrollment.course_class.id %}">
                                                {{ enrollment.course_class.class_code }}
                                            </a>
                                        </td>
                                        <td>{{ enrollment.enroll_time|date:"Y-m-d H:i" }}</td>
                                        <td>
                                            {% if enrollment.status == 'pending' %}
                                                <span class="badge bg-warning">待审核</span>
                                            {% elif enrollment.status == 'approved' %}
                                                <span class="badge bg-success">已通过</span>
                                            {% elif enrollment.status == 'rejected' %}
                                                <span class="badge bg-danger">已拒绝</span>
                                            {% elif enrollment.status == 'dropped' %}
                                                <span class="badge bg-secondary">已退课</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if enrollment.grade %}
                                                <span class="badge bg-info">{{ enrollment.grade }}</span>
                                            {% else %}
                                                <span class="text-muted">未录入</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if enrollment.status == 'pending' %}
                                                <form method="post" action="{% url 'courses:approve_enrollment' enrollment.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    <button type="submit" name="action" value="approve" class="btn btn-success btn-sm me-1">
                                                        <i class="fas fa-check"></i> 通过
                                                    </button>
                                                    <button type="submit" name="action" value="reject" class="btn btn-danger btn-sm">
                                                        <i class="fas fa-times"></i> 拒绝
                                                    </button>
                                                </form>
                                            {% elif enrollment.status == 'approved' %}
                                                <a href="{% url 'courses:grade_enrollment' enrollment.id %}" class="btn btn-info btn-sm me-1">
                                                    <i class="fas fa-edit"></i> 录入成绩
                                                </a>
                                                {% if user.user_type == 'admin' %}
                                                    <form method="post" action="{% url 'courses:approve_enrollment' enrollment.id %}" class="d-inline">
                                                        {% csrf_token %}
                                                        <button type="submit" name="action" value="drop" class="btn btn-warning btn-sm">
                                                            <i class="fas fa-minus"></i> 退课
                                                        </button>
                                                    </form>
                                                {% endif %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">
                                            <i class="fas fa-user-times fa-2x mb-2"></i>
                                            <p>暂无学生选择此课程</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info text-center">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>暂无学生选择此课程</p>
                        </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- 操作按钮 -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'courses:course_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回课程列表
                    </a>
                    <div>
                        {% if user.user_type == 'admin' %}
                            <a href="{% url 'courses:class_create' %}?course={{ course.id }}" class="btn btn-success me-2">
                                <i class="fas fa-plus"></i> 添加班次
                            </a>
                            <a href="{% url 'courses:course_update' course.id %}" class="btn btn-warning me-2">
                                <i class="fas fa-edit"></i> 编辑课程
                            </a>
                            <a href="{% url 'courses:course_delete' course.id %}" class="btn btn-danger">
                                <i class="fas fa-trash"></i> 删除课程
                            </a>
                        {% elif user.user_type == 'teacher' %}
                            <a href="{% url 'courses:class_create' %}?course={{ course.id }}" class="btn btn-success">
                                <i class="fas fa-plus"></i> 添加班次
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div class="col-md-4">
        <!-- 课程信息卡片 -->
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> 课程信息</h5>
            </div>
            <div class="card-body text-center">
                <div class="row mb-3">
                    <div class="col-6">
                        <h4 class="text-primary">{{ classes.count }}</h4>
                        <small class="text-muted">开设班次</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ total_capacity }}</h4>
                        <small class="text-muted">总容量</small>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <h4 class="text-info">{{ total_enrolled }}</h4>
                        <small class="text-muted">已选人数</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">{{ remaining_spots }}</h4>
                        <small class="text-muted">剩余名额</small>
                    </div>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar bg-info"
                         style="width: 50%">
                    </div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">选课率：50%</small>
                </div>
            </div>
        </div>

        <!-- 快速操作 -->
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> 快速操作</h5>
            </div>
            <div class="card-body">
                <a href="{% url 'courses:enrollment_list' %}?course={{ course.id }}" class="btn btn-outline-primary btn-sm mb-2 w-100">
                    <i class="fas fa-users"></i> 查看选课学生
                </a>
                {% if user.user_type == 'admin' %}
                    <a href="{% url 'courses:course_list' %}" class="btn btn-outline-info btn-sm mb-2 w-100">
                        <i class="fas fa-list"></i> 课程管理
                    </a>
                    <a href="{% url 'courses:class_list' %}" class="btn btn-outline-warning btn-sm mb-2 w-100">
                        <i class="fas fa-chalkboard"></i> 班次管理
                    </a>
                {% endif %}
                {% if user.user_type == 'student' %}
                    <a href="{% url 'courses:class_list' %}" class="btn btn-outline-success btn-sm w-100">
                        <i class="fas fa-search"></i> 浏览更多课程
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 为操作按钮添加确认对话框
    const forms = document.querySelectorAll('form[action*="approve_enrollment"]');
    forms.forEach(form => {
        const buttons = form.querySelectorAll('button');
        buttons.forEach(button => {
            if (button.name === 'action') {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const action = this.value;
                    let message = '';

                    if (action === 'approve') {
                        message = '确定要通过这个学生的选课申请吗？';
                    } else if (action === 'reject') {
                        message = '确定要拒绝这个学生的选课申请吗？';
                    } else if (action === 'drop') {
                        message = '确定要为这个学生办理退课吗？';
                    }

                    if (confirm(message)) {
                        form.submit();
                    }
                });
            }
        });
    });

    // 删除课程确认
    const deleteLink = document.querySelector('a[href*="delete"]');
    if (deleteLink) {
        deleteLink.addEventListener('click', function(e) {
            const courseName = '{{ course.course_name }}';
            const confirmDelete = confirm(`确定要删除课程"${courseName}"吗？\n\n删除后，所有相关的班次和选课记录都将被删除！`);

            if (!confirmDelete) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}