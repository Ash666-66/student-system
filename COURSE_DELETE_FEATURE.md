# 课程删除功能文档

## 功能概述

本文档描述了学生选课系统中课程删除功能的实现和使用方法。该功能提供了安全、可靠的课程删除机制，包含多重确认、风险评估和详细的影响分析。

## 功能特性

### 🔒 安全特性
- **多重权限验证**：仅管理员可删除课程
- **风险评估系统**：自动评估删除操作的风险等级
- **双重确认机制**：基础确认 + 高风险操作额外确认
- **异常处理**：完善的错误处理和回滚机制

### 📊 统计分析
- **实时统计**：班级数量、选课人数、容量信息
- **选课率计算**：可视化显示课程选课情况
- **影响范围分析**：详细列出删除影响的各类数据
- **平均班级大小**：提供课程规模分析

### 🎨 用户体验
- **响应式设计**：适配各种屏幕尺寸
- **视觉反馈**：动画效果和状态提示
- **键盘快捷键**：ESC取消，Ctrl+Enter确认
- **详细消息**：删除成功后显示具体影响数据

## 使用方法

### 基本删除流程

1. **访问课程详情页面**
   ```
   /courses/{course_id}/
   ```

2. **点击删除按钮**
   - 仅管理员用户可见删除按钮
   - 点击后进入删除确认页面

3. **确认删除操作**
   - 查看课程基本信息
   - 检查影响范围统计
   - 评估风险等级
   - 勾选确认复选框
   - 高风险操作需要额外确认
   - 点击确认删除按钮

### 风险评估等级

| 风险等级 | 触发条件 | 颜色标识 | 建议措施 |
|---------|---------|---------|---------|
| 低风险 | 班级数 ≤ 5 且 选课人数 = 0 | 绿色 | 正常删除 |
| 中等风险 | 班级数 > 5 或 选课人数 > 0 | 黄色 | 仔细检查影响范围 |
| 高风险 | 班级数 > 10 或 选课人数 > 50 | 红色 | 建议备份数据 |

### 高风险操作额外要求

当满足以下任一条件时，需要进行高风险确认：
- 班级数量超过 15 个
- 选课人数超过 100 人

## 技术实现

### 文件结构
```
student_system/
├── courses/
│   ├── views.py              # CourseDeleteView 视图
│   └── models.py             # 课程相关模型
└── templates/courses/
    └── course_confirm_delete.html  # 删除确认模板
```

### 核心组件

#### CourseDeleteView 视图
- 继承自 `DeleteView`
- 实现权限验证和风险评估
- 提供详细的上下文数据
- 异常处理和日志记录

#### 删除确认模板
- Bootstrap 5 响应式布局
- JavaScript 交互增强
- 多层次确认机制
- 视觉化统计展示

### API 端点
- **URL**: `/courses/<int:pk>/delete/`
- **方法**: POST
- **权限**: 仅管理员
- **参数**:
  - `high_risk_confirm`: 高风险操作确认（可选）

## 安全考虑

### 权限控制
- 使用 `IsAdminMixin` 进行权限验证
- 双重用户类型检查（超级用户 + 管理员角色）

### 数据保护
- 删除前收集完整统计信息
- 提供数据备份建议
- 详细的操作日志记录

### 异常处理
- 数据库操作异常捕获
- 用户友好的错误消息
- 安全的页面重定向

## 测试用例

### 基础功能测试
1. **权限验证测试**
   - 非管理员用户尝试删除课程
   - 预期结果：拒绝访问并显示错误消息

2. **空课程删除测试**
   - 删除没有班级和选课记录的课程
   - 预期结果：成功删除并显示简单消息

3. **有数据课程删除测试**
   - 删除有班级和选课记录的课程
   - 预期结果：成功删除并显示详细统计信息

### 高级功能测试
4. **风险评估测试**
   - 测试不同规模课程的风险等级计算
   - 验证颜色编码和消息提示

5. **高风险操作测试**
   - 触发高风险确认机制
   - 验证额外确认流程

6. **JavaScript 交互测试**
   - 测试键盘快捷键功能
   - 验证动画效果和状态变化

## 维护和扩展

### 添加新的风险评估规则
在 `CourseDeleteView.get_context_data()` 方法中修改风险评估逻辑：

```python
# 添加新的风险条件
if some_condition:
    risk_level = 'custom'
    risk_message = '自定义风险描述'
```

### 自定义删除后消息
在 `CourseDeleteView.delete()` 方法中修改消息生成逻辑：

```python
# 添加新的消息类型
if some_condition:
    message_parts.append('自定义消息')
```

### 扩展统计维度
在视图的统计计算部分添加新的指标：

```python
# 计算新的统计指标
new_metric = calculate_new_metric(course)
context['new_metric'] = new_metric
```

## 版本历史

- **v1.0** - 基础删除功能
- **v1.1** - 添加统计信息显示
- **v1.2** - 实现风险评估系统
- **v1.3** - 增强安全检查机制
- **v1.4** - 完善用户体验和响应式设计

## 支持和反馈

如有问题或建议，请联系开发团队或提交 Issue。

---

*最后更新：2025年12月*