{% extends 'base.html' %}
{% load static %}

{% block title %}管理员仪表板 - 学生选课系统{% endblock %}

{% block extra_css %}
<style>
/* 管理员仪表盘专用样式 */
.admin-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}
.admin-gradient-success {
    background: linear-gradient(135deg, #36D1DC 0%, #5B86E5 100%);
}
.admin-gradient-info {
    background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
}
.admin-gradient-warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}
.admin-gradient-danger {
    background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
}

.admin-stat-card {
    border: none;
    border-radius: 15px;
    transition: all 0.3s ease;
    overflow: hidden;
    position: relative;
    background: white;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.admin-stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
}

.admin-stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
}

.admin-icon {
    width: 70px;
    height: 70px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    color: white;
    margin-bottom: 1rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
}

.admin-progress {
    height: 8px;
    border-radius: 4px;
    background-color: #e9ecef;
    overflow: hidden;
}

.admin-progress-bar {
    border-radius: 4px;
    transition: width 0.6s ease;
}

.admin-chart-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    overflow: hidden;
}

.admin-table-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
}

.admin-quick-action {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    border-radius: 15px;
    color: white;
    transition: all 0.3s ease;
    text-align: center;
    padding: 1.5rem;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-decoration: none;
}

.admin-quick-action:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
    color: white;
    text-decoration: none;
}

.admin-quick-action i {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.metric-change {
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    border-radius: 20px;
    font-weight: 500;
}

.metric-change.positive {
    background-color: #d4edda;
    color: #155724;
}

.metric-change.negative {
    background-color: #f8d7da;
    color: #721c24;
}

.metric-change.neutral {
    background-color: #e2e3e5;
    color: #383d41;
}

.fade-in-up {
    animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.pulse-warning {
    animation: pulseWarning 2s infinite;
}

@keyframes pulseWarning {
    0% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(255, 193, 7, 0); }
    100% { box-shadow: 0 0 0 0 rgba(255, 193, 7, 0); }
}

/* 响应式优化 */
@media (max-width: 768px) {
    .admin-stat-card {
        margin-bottom: 1rem;
    }

    .admin-quick-action {
        min-height: 100px;
        padding: 1rem;
    }

    .admin-quick-action i {
        font-size: 2rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid fade-in-up">
    <!-- 页面头部 -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-4 border-bottom">
        <div>
            <h1 class="h2 mb-0">
                <i class="fas fa-tachometer-alt text-primary"></i>
                管理员仪表板
            </h1>
            <p class="text-muted mb-0">系统实时监控与数据分析</p>
        </div>
        <div class="btn-toolbar">
            <div class="btn-group">
                <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt"></i> 刷新数据
                </button>
                <a href="{% url 'courses:user_list' %}" class="btn btn-primary">
                    <i class="fas fa-users-cog"></i> 系统管理
                </a>
            </div>
        </div>
    </div>

    <!-- 核心统计指标 -->
    <div class="row mb-4">
        <!-- 用户统计 -->
        <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
            <div class="admin-stat-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="text-muted mb-0">总用户数</h6>
                                {% if new_users_this_week > 0 %}
                                <span class="metric-change positive">
                                    <i class="fas fa-arrow-up"></i> +{{ new_users_this_week }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-baseline">
                                <h2 class="mb-0 me-2">{{ total_users }}</h2>
                                <small class="text-muted">用户</small>
                            </div>
                            <div class="admin-progress mt-3">
                                <div class="admin-progress-bar admin-gradient-primary"
                                     style="width: {{ user_type_percentage|default:0 }}%"></div>
                            </div>
                            <small class="text-muted">
                                学生: {{ total_students }} | 教师: {{ total_teachers }} | 管理员: {{ total_admins }}
                            </small>
                        </div>
                        <div class="admin-icon admin-gradient-primary ms-3">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 课程统计 -->
        <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
            <div class="admin-stat-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="text-muted mb-0">课程班次</h6>
                                <small class="text-muted">{{ total_classes }} 个班次</small>
                            </div>
                            <div class="d-flex align-items-baseline">
                                <h2 class="mb-0 me-2">{{ total_courses }}</h2>
                                <small class="text-muted">门课程</small>
                            </div>
                            <div class="admin-progress mt-3">
                                <div class="admin-progress-bar admin-gradient-success"
                                     style="width: {{ enrollment_rate|default:0 }}%"></div>
                            </div>
                            <small class="text-muted">
                                选课率: {{ enrollment_rate|default:0 }}% | 容量: {{ total_capacity }}
                            </small>
                        </div>
                        <div class="admin-icon admin-gradient-success ms-3">
                            <i class="fas fa-book-open"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 选课统计 -->
        <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
            <div class="admin-stat-card h-100">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="text-muted mb-0">选课总数</h6>
                                {% if new_enrollments_today > 0 %}
                                <span class="metric-change positive">
                                    <i class="fas fa-arrow-up"></i> 今日+{{ new_enrollments_today }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-baseline">
                                <h2 class="mb-0 me-2">{{ total_enrolled }}</h2>
                                <small class="text-muted">已选</small>
                            </div>
                            <div class="admin-progress mt-3">
                                <div class="admin-progress-bar admin-gradient-info"
                                     style="width: {{ enrollment_rate|default:0 }}%"></div>
                            </div>
                            <small class="text-muted">
                                剩余名额: {{ total_available }} | 容量: {{ total_capacity }}
                            </small>
                        </div>
                        <div class="admin-icon admin-gradient-info ms-3">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 待处理事项 -->
        <div class="col-xl-3 col-lg-6 col-md-6 mb-4">
            <div class="admin-stat-card h-100 {% if pending_enrollments > 0 %}pulse-warning{% endif %}">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <h6 class="text-muted mb-0">待处理</h6>
                                {% if pending_enrollments > 0 %}
                                <span class="metric-change negative">
                                    <i class="fas fa-exclamation-triangle"></i> 需处理
                                </span>
                                {% endif %}
                            </div>
                            <div class="d-flex align-items-baseline">
                                <h2 class="mb-0 me-2">{{ pending_enrollments }}</h2>
                                <small class="text-muted">待审核</small>
                            </div>
                            <div class="mt-3">
                                <small class="text-muted">
                                    待审核: {{ pending_enrollments }} |
                                    已拒绝: {{ rejected_enrollments }} |
                                    已退课: {{ dropped_enrollments }}
                                </small>
                            </div>
                        </div>
                        <div class="admin-icon admin-gradient-warning ms-3">
                            <i class="fas fa-tasks"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- 快速操作面板 -->
        <div class="col-xl-4 col-lg-6 mb-4">
            <div class="admin-chart-card">
                <div class="card-header bg-transparent border-0 pt-4 pb-0">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt text-warning"></i>
                        快速操作
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-6">
                            <a href="{% url 'courses:user_list' %}" class="admin-quick-action">
                                <i class="fas fa-users"></i>
                                <h6 class="mb-0">用户管理</h6>
                                <small>{{ total_users }} 个用户</small>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'courses:course_create' %}" class="admin-quick-action">
                                <i class="fas fa-plus-circle"></i>
                                <h6 class="mb-0">添加课程</h6>
                                <small>{{ total_courses }} 门课程</small>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'courses:class_create' %}" class="admin-quick-action">
                                <i class="fas fa-chalkboard"></i>
                                <h6 class="mb-0">添加班次</h6>
                                <small>{{ total_classes }} 个班次</small>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="{% url 'courses:enrollment_list' %}" class="admin-quick-action">
                                <i class="fas fa-tasks"></i>
                                <h6 class="mb-0">选课审核</h6>
                                <small>{% if pending_enrollments > 0 %}{{ pending_enrollments }} 待处理{% else %}无待处理{% endif %}</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 用户类型分布 -->
        <div class="col-xl-4 col-lg-6 mb-4">
            <div class="admin-chart-card">
                <div class="card-header bg-transparent border-0 pt-4 pb-0">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie text-info"></i>
                        用户类型分布
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 250px;">
                        <canvas id="userTypeChart"></canvas>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            总计: {{ total_users }} 用户
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 选课状态分布 -->
        <div class="col-xl-4 col-lg-6 mb-4">
            <div class="admin-chart-card">
                <div class="card-header bg-transparent border-0 pt-4 pb-0">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar text-success"></i>
                        选课状态分布
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 250px;">
                        <canvas id="enrollmentStatusChart"></canvas>
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            总计: {{ total_enrollment_records }} 条记录
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 详细统计表格 -->
    <div class="row">
        <!-- 热门课程 -->
        <div class="col-xl-6 mb-4">
            <div class="admin-table-card">
                <div class="card-header bg-transparent border-0 pt-4 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-fire text-danger"></i>
                            热门课程班次
                        </h5>
                        <a href="{% url 'courses:course_list' %}" class="btn btn-sm btn-outline-primary">
                            查看全部
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if popular_courses %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>课程名称</th>
                                        <th>班次</th>
                                        <th>教师</th>
                                        <th class="text-center">选课人数</th>
                                        <th class="text-center">容量</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for course_class in popular_courses %}
                                    <tr>
                                        <td>{{ course_class.course.course_name }}</td>
                                        <td>{{ course_class.class_code }}</td>
                                        <td>{{ course_class.teacher.username }}</td>
                                        <td class="text-center">
                                            <span class="badge bg-primary">{{ course_class.enrollment_count }}</span>
                                        </td>
                                        <td class="text-center">{{ course_class.max_students }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">暂无课程数据</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 教师工作量 -->
        <div class="col-xl-6 mb-4">
            <div class="admin-table-card">
                <div class="card-header bg-transparent border-0 pt-4 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chalkboard-teacher text-warning"></i>
                            教师工作量排名
                        </h5>
                        <a href="{% url 'courses:user_list' %}" class="btn btn-sm btn-outline-primary">
                            查看全部
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if teacher_workload %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>教师姓名</th>
                                        <th class="text-center">班次数量</th>
                                        <th class="text-center">学生总数</th>
                                        <th class="text-center">平均每班</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for teacher in teacher_workload %}
                                    <tr>
                                        <td>{{ teacher.teacher__username }}</td>
                                        <td class="text-center">
                                            <span class="badge bg-info">{{ teacher.class_count }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success">{{ teacher.student_count }}</span>
                                        </td>
                                        <td class="text-center">
                                            {{ teacher.avg_students|default:0 }}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                            <p class="text-muted">暂无教师数据</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- 系统活跃度 -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="admin-chart-card">
                <div class="card-header bg-transparent border-0 pt-4 pb-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line text-primary"></i>
                            系统活跃度概览
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary active" onclick="changeTimeRange('week', this)">本周</button>
                            <button class="btn btn-outline-primary" onclick="changeTimeRange('month', this)">本月</button>
                            <button class="btn btn-outline-primary" onclick="changeTimeRange('year', this)">本年</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center p-3">
                                <h4 class="text-primary mb-1">{{ new_users_this_week }}</h4>
                                <p class="text-muted mb-0">本周新增用户</p>
                                <small class="text-success">
                                    <i class="fas fa-arrow-up"></i> 较上周增长
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3">
                                <h4 class="text-success mb-1">{{ new_users_this_month }}</h4>
                                <p class="text-muted mb-0">本月新增用户</p>
                                <small class="text-info">
                                    <i class="fas fa-users"></i> 累计注册
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-3">
                                <h4 class="text-warning mb-1">{{ new_enrollments_today }}</h4>
                                <p class="text-muted mb-0">今日选课数量</p>
                                <small class="text-warning">
                                    <i class="fas fa-chart-bar"></i> 实时更新
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="chart-container mt-4" style="position: relative; height: 300px;">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 配置Chart.js默认设置
    Chart.defaults.font.family = '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif';
    Chart.defaults.color = '#4a5568';

    // 用户类型分布饼图
    const userTypeCtx = document.getElementById('userTypeChart');
    if (userTypeCtx) {
        new Chart(userTypeCtx, {
            type: 'doughnut',
            data: {
                labels: ['学生', '教师', '管理员'],
                datasets: [{
                    data: [{{ total_students }}, {{ total_teachers }}, {{ total_admins }}],
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(118, 75, 162, 0.8)',
                        'rgba(255, 193, 7, 0.8)'
                    ],
                    borderColor: [
                        'rgba(102, 126, 234, 1)',
                        'rgba(118, 75, 162, 1)',
                        'rgba(255, 193, 7, 1)'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    // 选课状态分布柱状图
    const enrollmentStatusCtx = document.getElementById('enrollmentStatusChart');
    if (enrollmentStatusCtx) {
        new Chart(enrollmentStatusCtx, {
            type: 'bar',
            data: {
                labels: ['已通过', '待审核', '已拒绝', '已退课'],
                datasets: [{
                    label: '选课数量',
                    data: [{{ total_enrollments }}, {{ pending_enrollments }}, {{ rejected_enrollments }}, {{ dropped_enrollments }}],
                    backgroundColor: [
                        'rgba(40, 167, 69, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(220, 53, 69, 0.8)',
                        'rgba(108, 117, 125, 0.8)'
                    ],
                    borderColor: [
                        'rgba(40, 167, 69, 1)',
                        'rgba(255, 193, 7, 1)',
                        'rgba(220, 53, 69, 1)',
                        'rgba(108, 117, 125, 1)'
                    ],
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.label}: ${context.parsed.y} 条记录`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // 系统活跃度图表
    const activityCtx = document.getElementById('activityChart');
    if (activityCtx) {
        // 生成模拟的活跃度数据
        const generateActivityData = () => {
            const data = [];
            const labels = [];
            const today = new Date();

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' }));
                data.push(Math.floor(Math.random() * 50) + 10);
            }

            return { labels, data };
        };

        const activityData = generateActivityData();

        new Chart(activityCtx, {
            type: 'line',
            data: {
                labels: activityData.labels,
                datasets: [{
                    label: '每日选课数量',
                    data: activityData.data,
                    borderColor: 'rgba(102, 126, 234, 1)',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        grid: {
                            display: false
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
    }

    // 添加数字动画效果
    const animateNumbers = () => {
        const elements = document.querySelectorAll('.admin-stat-card h2');
        elements.forEach(element => {
            const finalValue = parseInt(element.textContent);
            if (!isNaN(finalValue)) {
                let currentValue = 0;
                const increment = finalValue / 50;
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        currentValue = finalValue;
                        clearInterval(timer);
                    }
                    element.textContent = Math.floor(currentValue);
                }, 20);
            }
        });
    };

    // 延迟执行动画
    setTimeout(animateNumbers, 300);

    // 页面可见性API - 当页面重新可见时刷新数据
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            refreshDashboard();
        }
    });
});

// 刷新仪表盘数据
function refreshDashboard() {
    // 显示加载状态
    const refreshBtn = document.querySelector('[onclick="refreshDashboard()"]');
    if (refreshBtn) {
        const originalHTML = refreshBtn.innerHTML;
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 刷新中...';
        refreshBtn.disabled = true;

        // 模拟数据刷新
        setTimeout(() => {
            refreshBtn.innerHTML = originalHTML;
            refreshBtn.disabled = false;

            // 显示成功提示
            showNotification('数据已刷新', 'success');
        }, 1000);
    }
}

// 切换时间范围
function changeTimeRange(range, button) {
    // 更新按钮状态
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');

    // 这里可以根据range重新获取数据
    showNotification(`已切换到${range === 'week' ? '本周' : range === 'month' ? '本月' : '本年'}数据`, 'info');
}

// 显示通知
function showNotification(message, type = 'info') {
    const alertClass = type === 'success' ? 'alert-success' :
                      type === 'error' ? 'alert-danger' :
                      type === 'warning' ? 'alert-warning' : 'alert-info';

    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 250px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    document.body.appendChild(notification);

    // 自动移除通知
    setTimeout(() => {
        notification.remove();
    }, 3000);
}
</script>
{% endblock %}