{% extends 'base.html' %}

{% block title %}{{ class.class_code }} - {{ class.course.course_name }} - 学生选课系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0">
                    <i class="fas fa-chalkboard"></i>
                    {{ class.class_code }} - {{ class.course.course_name }}
                </h4>
            </div>
            <div class="card-body">
                <!-- 基本信息 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle"></i> 基本信息</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>课程代码:</strong></td>
                                <td>{{ class.course.course_code }}</td>
                            </tr>
                            <tr>
                                <td><strong>课程名称:</strong></td>
                                <td>{{ class.course.course_name }}</td>
                            </tr>
                            <tr>
                                <td><strong>班次代码:</strong></td>
                                <td>{{ class.class_code }}</td>
                            </tr>
                            <tr>
                                <td><strong>学分:</strong></td>
                                <td>{{ class.course.credits }} 学分</td>
                            </tr>
                            <tr>
                                <td><strong>课时:</strong></td>
                                <td>{{ class.course.hours }} 学时</td>
                            </tr>
                            <tr>
                                <td><strong>学期:</strong></td>
                                <td>{{ class.semester|default:"未设定" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-user-graduate"></i> 授课信息</h6>
                        <table class="table table-sm">
                            <tr>
                                <td><strong>授课教师:</strong></td>
                                <td>{{ class.teacher.username }}</td>
                            </tr>
                            <tr>
                                <td><strong>教室:</strong></td>
                                <td>{{ class.classroom|default:"未设定" }}</td>
                            </tr>
                            <tr>
                                <td><strong>上课时间:</strong></td>
                                <td>{{ class.schedule|default:"未设定" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- 课程描述 -->
                {% if class.course.description %}
                <div class="mb-4">
                    <h6><i class="fas fa-file-alt"></i> 课程描述</h6>
                    <div class="alert alert-light">
                        {{ class.course.description|linebreaks }}
                    </div>
                </div>
                {% endif %}

                <!-- 选课状态 -->
                <div class="mb-4">
                    <h6><i class="fas fa-users"></i> 选课状态</h6>
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <div class="text-center">
                                <h4 class="{% if class.is_full %}text-danger{% else %}text-success{% endif %}">
                                    {{ class.current_students }} / {{ class.max_students }}
                                </h4>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar {% if class.is_full %}bg-danger{% else %}bg-success{% endif %}"
                                         style="width: {% widthratio class.current_students class.max_students 100 %}%"
                                         title="{{ class.current_students }}/{{ class.max_students }}">
                                    </div>
                                </div>
                                <span class="badge {% if class.is_full %}bg-danger{% else %}bg-success{% endif %}">
                                    {% if class.is_full %}已满{% else %}可选{% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="col-md-8">
                            {% if user.user_type == 'student' %}
                                <div class="d-flex justify-content-end">
                                    {% if enrollments %}
                                        {% for enrollment in enrollments %}
                                            {% if enrollment.student == user %}
                                                <div class="me-3">
                                                    <span class="badge {% if enrollment.status == 'pending' %}bg-warning{% elif enrollment.status == 'approved' %}bg-success{% elif enrollment.status == 'rejected' %}bg-danger{% elif enrollment.status == 'dropped' %}bg-secondary{% endif %}">
                                                        您的选课状态：{% if enrollment.status == 'pending' %}待审核{% elif enrollment.status == 'approved' %}已通过{% elif enrollment.status == 'rejected' %}已拒绝{% elif enrollment.status == 'dropped' %}已退课{% endif %}
                                                    </span>
                                                    {% if enrollment.status == 'approved' and enrollment.grade %}
                                                        <span class="badge bg-info ms-2">成绩：{{ enrollment.grade }}</span>
                                                    {% endif %}
                                                </div>
                                                {% if enrollment.status == 'approved' %}
                                                    <a href="{% url 'courses:class_unenroll' class.id %}" class="btn btn-warning btn-sm">
                                                        <i class="fas fa-minus"></i> 申请退课
                                                    </a>
                                                {% elif enrollment.status == 'pending' %}
                                                    <a href="{% url 'courses:enrollment_cancel' enrollment.id %}" class="btn btn-danger btn-sm">
                                                        <i class="fas fa-times"></i> 取消申请
                                                    </a>
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% else %}
                                        {% if class.current_students < class.max_students %}
                                            <a href="{% url 'courses:enroll_course' class.id %}" class="btn btn-success btn-lg">
                                                <i class="fas fa-plus-circle"></i> 立即选课
                                            </a>
                                        {% else %}
                                            <button class="btn btn-secondary btn-lg" disabled>
                                                <i class="fas fa-times-circle"></i> 班次已满
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            {% elif user.user_type == 'admin' or user.user_type == 'teacher' %}
                                <div class="d-flex justify-content-end">
                                    {% if user.user_type == 'admin' %}
                                        <a href="{% url 'courses:class_update' class.id %}" class="btn btn-warning btn-sm me-2">
                                            <i class="fas fa-edit"></i> 编辑班次
                                        </a>
                                        <a href="{% url 'courses:class_delete' class.id %}" class="btn btn-danger btn-sm me-2">
                                            <i class="fas fa-trash"></i> 删除班次
                                        </a>
                                    {% endif %}
                                    <a href="{% url 'courses:enrollment_list' %}?class={{ class.id }}" class="btn btn-info btn-sm">
                                        <i class="fas fa-list"></i> 查看选课学生
                                    </a>
                                    {% if user.user_type == 'teacher' %}
                                        <a href="{% url 'courses:course_update' class.course.id %}" class="btn btn-outline-primary btn-sm me-2">
                                            <i class="fas fa-book"></i> 编辑课程
                                        </a>
                                        <a href="{% url 'courses:class_create' %}?course={{ class.course.id }}" class="btn btn-success btn-sm">
                                            <i class="fas fa-plus"></i> 添加新班次
                                        </a>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 公告列表 -->
                {% if announcements %}
                <div class="mb-4">
                    <h6><i class="fas fa-bullhorn"></i> 课程公告</h6>
                    <div class="list-group">
                        {% for announcement in announcements %}
                        <div class="list-group-item {% if not announcement.is_active %}list-group-item-light{% endif %}">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">{{ announcement.title }}</h6>
                                <small class="text-muted">{{ announcement.created_at|date:"Y-m-d H:i" }}</small>
                            </div>
                            <p class="mb-1">{{ announcement.content|linebreaks }}</p>
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">发布者：{{ announcement.author.username }}</small>
                                {% if not announcement.is_active %}
                                    <span class="badge bg-secondary">已禁用</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- 已选学生列表（教师和管理员可见） -->
                {% if user.user_type == 'admin' or user.user_type == 'teacher' %}
                <div class="mb-4">
                    <h6><i class="fas fa-users"></i> 已选学生</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>学号</th>
                                    <th>姓名</th>
                                    <th>选课时间</th>
                                    <th>审核状态</th>
                                    <th>成绩</th>
                                    {% if user.user_type == 'admin' %}
                                    <th>操作</th>
                                    {% elif user.user_type == 'teacher' and class.teacher == user %}
                                    <th>操作</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for enrollment in enrollments %}
                                <tr>
                                    <td>
                                        {% if enrollment.student.studentprofile %}
                                            {{ enrollment.student.studentprofile.student_number }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ enrollment.student.username }}</td>
                                    <td>{{ enrollment.enroll_time|date:"Y-m-d H:i" }}</td>
                                    <td>
                                        {% if enrollment.status == 'pending' %}
                                            <span class="badge bg-warning">待审核</span>
                                        {% elif enrollment.status == 'approved' %}
                                            <span class="badge bg-success">已通过</span>
                                        {% elif enrollment.status == 'rejected' %}
                                            <span class="badge bg-danger">已拒绝</span>
                                        {% elif enrollment.status == 'dropped' %}
                                            <span class="badge bg-secondary">已退课</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if enrollment.grade %}
                                            <span class="badge bg-info">{{ enrollment.grade }}</span>
                                        {% else %}
                                            <span class="text-muted">未录入</span>
                                        {% endif %}
                                    </td>
                                    {% if user.user_type == 'admin' %}
                                    <td>
                                        {% if enrollment.status == 'pending' %}
                                            <form method="post" action="{% url 'courses:approve_enrollment' enrollment.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" name="action" value="approve" class="btn btn-success btn-sm me-1">
                                                    <i class="fas fa-check"></i> 通过
                                                </button>
                                                <button type="submit" name="action" value="reject" class="btn btn-danger btn-sm">
                                                    <i class="fas fa-times"></i> 拒绝
                                                </button>
                                            </form>
                                        {% elif enrollment.status == 'approved' %}
                                            <a href="{% url 'courses:grade_enrollment' enrollment.id %}" class="btn btn-info btn-sm me-1">
                                                <i class="fas fa-edit"></i> 录入成绩
                                            </a>
                                            {% if user.user_type == 'admin' %}
                                                <form method="post" action="{% url 'courses:approve_enrollment' enrollment.id %}" class="d-inline">
                                                    {% csrf_token %}
                                                    <button type="submit" name="action" value="drop" class="btn btn-warning btn-sm">
                                                        <i class="fas fa-minus"></i> 退课
                                                    </button>
                                                </form>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    {% elif user.user_type == 'teacher' and class.teacher == user %}
                                    <td>
                                        {% if enrollment.status == 'pending' %}
                                            <form method="post" action="{% url 'courses:approve_enrollment' enrollment.id %}" class="d-inline">
                                                {% csrf_token %}
                                                <button type="submit" name="action" value="approve" class="btn btn-success btn-sm me-1">
                                                    <i class="fas fa-check"></i> 通过
                                                </button>
                                                <button type="submit" name="action" value="reject" class="btn btn-danger btn-sm">
                                                    <i class="fas fa-times"></i> 拒绝
                                                </button>
                                            </form>
                                        {% elif enrollment.status == 'approved' %}
                                            <a href="{% url 'courses:grade_enrollment' enrollment.id %}" class="btn btn-info btn-sm me-1">
                                                <i class="fas fa-edit"></i> 录入成绩
                                            </a>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="{% if user.user_type == 'admin' %}6{% elif user.user_type == 'teacher' and class.teacher == user %}6{% else %}5{% endif %}" class="text-center text-muted">
                                        <i class="fas fa-user-times fa-2x mb-2"></i>
                                        <p>暂无学生选择此班次</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- 操作按钮 -->
                <div class="d-flex justify-content-between">
                    <a href="{% url 'courses:class_list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> 返回班次列表
                    </a>
                    <div>
                        <a href="{% url 'courses:course_detail' class.course.id %}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-book"></i> 查看课程详情
                        </a>
                        {% if user.user_type == 'student' and class.current_students < class.max_students %}
                            <a href="{% url 'courses:enroll_course' class.id %}" class="btn btn-success">
                                <i class="fas fa-plus-circle"></i> 立即选课
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 侧边栏 -->
    <div class="col-md-4">
        <!-- 教师信息 -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user-tie"></i> 授课教师</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-user-circle fa-5x text-primary"></i>
                </div>
                <h6>{{ class.teacher.username }}</h6>
                {% if class.teacher.teacherprofile %}
                <p class="text-muted">
                    {% if class.teacher.teacherprofile.title %}
                        {{ class.teacher.teacherprofile.title }}
                    {% endif %}
                    {% if class.teacher.teacherprofile.department %}
                        | {{ class.teacher.teacherprofile.department }}
                    {% endif %}
                </p>
                {% endif %}
                {% if user.user_type == 'admin' or user.user_type == 'teacher' %}
                    <a href="mailto:{{ class.teacher.email|default:'' }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-envelope"></i> 联系教师
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- 选课统计 -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> 选课统计</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ enrollments|length }}</h4>
                        <small class="text-muted">已选人数</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-warning">{{ class.max_students }}</h4>
                        <small class="text-muted">最大人数</small>
                    </div>
                </div>
                <div class="progress mt-3" style="height: 15px;">
                    <div class="progress-bar bg-info"
                         style="width: {% widthratio class.current_students class.max_students 100 %}%">
                    </div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">剩余名额：{{ class.available_spots }}</small>
                </div>
            </div>
        </div>

        <!-- 快速操作 -->
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-bolt"></i> 快速操作</h5>
            </div>
            <div class="card-body">
                {% if user.user_type == 'student' %}
                    <a href="{% url 'courses:class_list' %}" class="btn btn-outline-primary btn-sm mb-2 w-100">
                        <i class="fas fa-search"></i> 浏览更多班次
                    </a>
                    <a href="{% url 'courses:enrollment_list' %}" class="btn btn-outline-info btn-sm mb-2 w-100">
                        <i class="fas fa-clipboard-list"></i> 我的选课记录
                    </a>
                {% elif user.user_type == 'admin' or user.user_type == 'teacher' %}
                    <a href="{% url 'courses:enrollment_list' %}?class={{ class.id }}" class="btn btn-outline-primary btn-sm mb-2 w-100">
                        <i class="fas fa-users"></i> 管理选课学生
                    </a>
                    {% if user.user_type == 'teacher' %}
                        <a href="{% url 'courses:announcement_create' %}?class={{ class.id }}" class="btn btn-outline-success btn-sm mb-2 w-100">
                            <i class="fas fa-bullhorn"></i> 发布公告
                        </a>
                    {% endif %}
                    {% if user.user_type == 'admin' %}
                        <a href="{% url 'courses:class_update' class.id %}" class="btn btn-outline-warning btn-sm mb-2 w-100">
                            <i class="fas fa-edit"></i> 编辑班次
                        </a>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 为操作按钮添加确认对话框
    const forms = document.querySelectorAll('form[action*="approve_enrollment"]');
    forms.forEach(form => {
        const buttons = form.querySelectorAll('button');
        buttons.forEach(button => {
            if (button.name === 'action') {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const action = this.value;
                    let message = '';

                    if (action === 'approve') {
                        message = '确定要通过这个学生的选课申请吗？';
                    } else if (action === 'reject') {
                        message = '确定要拒绝这个学生的选课申请吗？';
                    } else if (action === 'drop') {
                        message = '确定要为这个学生办理退课吗？';
                    }

                    if (confirm(message)) {
                        form.submit();
                    }
                });
            }
        });
    });

    // 选课按钮确认
    const enrollBtn = document.querySelector('a[href*="enroll_course"]');
    if (enrollBtn) {
        enrollBtn.addEventListener('click', function(e) {
            const className = '{{ class.class_code }}';
            const courseName = '{{ class.course.course_name }}';
            const confirmEnroll = confirm(`确定要选择班次 ${className} (${courseName}) 吗？`);

            if (!confirmEnroll) {
                e.preventDefault();
            }
        });
    }
});
</script>
{% endblock %}